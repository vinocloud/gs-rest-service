// Jenkinsfile
pipeline {
    agent any

    environment {
        APP_NAME = "gs-rest-service"
        DOCKER_IMAGE_NAME = "${APP_NAME}-app"
        DOCKER_CONTAINER_NAME = "${APP_NAME}-container"
        HOST_APP_PORT = 8081
        CONTAINER_APP_PORT = 8080

        // Your Dockerfile is in the root of the checked-out repo.
        // The Gradle project is under the 'complete' subdirectory.
        // So, the Docker build context needs to be the root of the repo ('.').
        // The Dockerfile itself is also at the root.
        // The paths *inside* the Dockerfile will reference 'complete/...'
    }

    stages {
        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }
        stage('Checkout Source Code') {
            steps {
                // Checkout the entire repository into the root of the workspace.
                // This will place Dockerfile, complete/, etc. directly under the workspace.
                git branch: 'main', url: 'https://github.com/vinocloud/gs-rest-service' // Use your forked repo URL
            }
        }
        stage('Debug Workspace Structure') {
            steps {
                echo "Listing workspace contents after checkout:"
                sh 'ls -R' // List recursively to see the full tree
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    // We are NOT changing the directory with 'dir()' here.
                    // The Dockerfile is at the root of the workspace after checkout,
                    // and the build context needs to be that root.
                    echo "Building Docker image: ${DOCKER_IMAGE_NAME}:latest from directory: ${pwd()}"
                    // The '.' specifies the current directory (workspace root) as the build context.
                    // Docker will find 'Dockerfile' here.
                    sh "docker build -t ${DOCKER_IMAGE_NAME}:latest ."
                    echo "Docker image built successfully."
                }
            }
        }
        stage('Stop and Remove Old Container (if exists)') {
            steps {
                script {
                    echo "Checking for existing container: ${DOCKER_CONTAINER_NAME}"
                    def containerId = sh(returnStdout: true, script: "docker ps -aq -f name=${DOCKER_CONTAINER_NAME}").trim()

                    if (containerId) {
                        echo "Found existing container ${DOCKER_CONTAINER_NAME} with ID: ${containerId}"
                        try {
                            sh "docker stop ${containerId}"
                            echo "Stopped container ${DOCKER_CONTAINER_NAME}."
                        } catch (Exception e) {
                            echo "Could not stop container ${DOCKER_CONTAINER_NAME}. It might already be stopped or not running."
                        }
                        try {
                            sh "docker rm ${containerId}"
                            echo "Removed container ${DOCKER_CONTAINER_NAME}."
                        } catch (Exception e) {
                            echo "Could not remove container ${DOCKER_CONTAINER_NAME}. It might have already been removed."
                        }
                    } else {
                        echo "No existing container ${DOCKER_CONTAINER_NAME} found. Skipping stop/remove."
                    }
                }
            }
        }
        stage('Run New Docker Container') {
            steps {
                script {
                    echo "Running new Docker container: ${DOCKER_CONTAINER_NAME}"
                    sh "docker run -d -p ${HOST_APP_PORT}:${CONTAINER_APP_PORT} --name ${DOCKER_CONTAINER_NAME} ${DOCKER_IMAGE_NAME}:latest"
                    echo "Spring Boot application container is running on http://localhost:${HOST_APP_PORT}"
                }
            }
        }
    }
    post {
        always {
            echo "Deployment pipeline finished."
        }
        failure {
            echo "Deployment pipeline failed. Check logs for details."
        }
    }
}
